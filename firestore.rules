/**
 * # Firestore Security Rules for IARE Clubs
 *
 * ## Core Philosophy
 * This ruleset is for the IARE Clubs application, a platform for student organizations at the Institute of Aeronautical Engineering, Hyderabad. 
 * It enforces a security model based on user ownership and a distinct "Club Admin" role, supplemented by a global system administrator. 
 * The model is designed for security and scalability, ensuring students can only access their own private data while allowing for 
 * controlled management of shared resources like clubs and events.
 *
 * ## Data Structure
 * - `/users/{userId}`: Contains private student/faculty profile data. Access is strictly limited to the document owner.
 * - `/clubs/{clubId}`: A top-level collection for clubs. Access to modify a club or its subcollections is governed by an `adminId` field.
 * - `/clubMemberships`: Manages the many-to-many relationship between users and clubs.
 *
 * ## Key Security Decisions
 * - **User Data Privacy**: All data under `/users/{userId}` is strictly private.
 * - **Club Admin Authority**: A user whose UID is in a club's `adminId` field has full control over that club and its nested documents.
 * - **Global Admin**: A specific email address (`devanshedam@gmail.com`) is granted global admin privileges.
 * - **Public Discoverability via Approval**: Only clubs with a `status` of 'approved' are publicly readable.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------------------
    // Helper Functions
    // ---------------------------------------------------------------------

    /**
     * The email of the designated global system administrator.
     */
    function ADMIN_EMAIL() {
      return 'devanshedam@gmail.com';
    }

    /**
     * Checks if the currently authenticated user is the global system admin.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == ADMIN_EMAIL();
    }
    
    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update/delete.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the authenticated user is the admin of a specific club.
     * This requires one 'get' call to the parent club document.
     */
    function isClubAdmin(clubId) {
      return isSignedIn() && get(/databases/$(database)/documents/clubs/$(clubId)).data.adminId == request.auth.uid;
    }

    /**
     * Checks for club admin role on an existing document. Used for update/delete.
     */
    function isExistingClubAdmin(clubId) {
      return resource != null && isClubAdmin(clubId);
    }

    /**
     * Validates that the user ID in a newly created document matches the user's
     * auth UID, enforcing a link between the document and its owner.
     */
    function userIsSelf(data) {
      return data.userId == request.auth.uid;
    }
    
    /**
     * Validates that the user ID field remains unchanged during an update.
     */
    function userIdIsImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }
    
    // ---------------------------------------------------------------------
    // User Profile Rules
    // ---------------------------------------------------------------------

    /**
     * @description A user can manage their own profile. Admins can list all users.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) || isAdmin();
      allow delete: if isExistingOwner(userId) || isAdmin();

      // --- Nested User Collections ---

      /**
       * @description A user can manage their own event registrations.
       * @path /users/{userId}/registrations/{registrationId}
       */
      match /registrations/{registrationId} {
        allow get, list: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        allow update: if (isExistingOwner(userId) && userIdIsImmutable()) || isAdmin();
        allow delete: if isExistingOwner(userId) || isAdmin();
      }
    }

    // ---------------------------------------------------------------------
    // Club & Event Rules
    // ---------------------------------------------------------------------

    /**
     * @description Clubs are publicly readable if 'approved', but only manageable by their designated admin or a global admin.
     * @path /clubs/{clubId}
     */
    match /clubs/{clubId} {
      allow get: if resource.data.status == 'approved' || isOwner(resource.data.adminId) || isAdmin();
      // Allow listing clubs for admins, club admins fetching their own clubs, or anyone fetching approved clubs.
      allow list: if isSignedIn() && (
                    isAdmin() ||
                    (request.query.keys().hasOnly(['where', 'limit']) && request.query.where[0][0] == 'id') ||
                    (request.query.keys().hasOnly(['where', 'limit']) && request.query.where[0][0] == 'status' && request.query.where[0][2] == 'approved')
                  );
      
      allow create: if isSignedIn() 
                    && request.resource.data.adminId == request.auth.uid 
                    && request.resource.data.status == 'pending';
                    
      allow update: if (isOwner(resource.data.adminId) && request.resource.data.keys().diff(resource.data.keys()).hasOnly(['name', 'description', 'logoUrl']))
                    || isAdmin(); // Admin can update anything.
                    
      allow delete: if (isOwner(resource.data.adminId) || isAdmin());
      
      /**
       * @description Events are publicly readable if the club is approved, but managed by the parent club's admin.
       * @path /clubs/{clubId}/events/{eventId}
       */
      match /events/{eventId} {
        allow get, list: if get(/databases/$(database)/documents/clubs/$(clubId)).data.status == 'approved' || isClubAdmin(clubId) || isAdmin();
        allow create: if isClubAdmin(clubId) || isAdmin();
        allow update: if isExistingClubAdmin(clubId) || isAdmin();
        allow delete: if isExistingClubAdmin(clubId) || isAdmin();

        /**
         * @description Event reports are private and only accessible by the club admin.
         * @path /clubs/{clubId}/events/{eventId}/reports/{reportId}
         */
        match /reports/{reportId} {
          allow get, list: if isClubAdmin(clubId) || isAdmin();
          allow create: if isClubAdmin(clubId) || isAdmin();
          allow update: if isExistingClubAdmin(clubId) || isAdmin();
          allow delete: if isExistingClubAdmin(clubId) || isAdmin();
        }
      }
    }

    // ---------------------------------------------------------------------
    // Club Membership Rules
    // ---------------------------------------------------------------------

    /**
     * @description Users can join/leave approved clubs. Club admins can remove members.
     * @path /clubMemberships/{clubMembershipId}
     */
    match /clubMemberships/{clubMembershipId} {
      allow read: if true;
      allow create: if isSignedIn() 
                    && userIsSelf(request.resource.data)
                    && get(/databases/$(database)/documents/clubs/$(request.resource.data.clubId)).data.status == 'approved';
      allow update: if false; // Memberships should be created/deleted, not updated.
      allow delete: if resource != null && (isOwner(resource.data.userId) || isClubAdmin(resource.data.clubId) || isAdmin());
    }
  }
}
